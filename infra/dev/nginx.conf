worker_processes auto;

events {
  worker_connections 4096;
}

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile on;
  tcp_nopush on;
  keepalive_timeout 65;

  proxy_cache_path /var/cache/nginx/hls levels=1:2 keys_zone=hls_cache:50m max_size=5g inactive=30m use_temp_path=off;

  upstream auth_api {
    server host.docker.internal:8080;
  }

  upstream storage_minio {
    server minio:9000;
  }

  server {
    listen 80;
    server_name _;

    # Admin/testing only direct HLS route
    location /hls/ {
      proxy_pass http://storage_minio/streams/;
      proxy_http_version 1.1;

      # Cache segments, not manifests aggressively
      if ($request_uri ~* "\.ts$") {
        add_header Cache-Control "public,max-age=30";
        proxy_cache hls_cache;
        proxy_cache_valid 200 30s;
      }

      if ($request_uri ~* "\.m3u8$") {
        add_header Cache-Control "no-store";
        proxy_no_cache 1;
        proxy_cache_bypass 1;
      }
    }

    # Gated route: /play/{session_id}/... 
    location ~ ^/play/([A-Za-z0-9_-]+)/(.+)$ {
      set $session_id $1;
      set $asset_path $2;

      # Token check stub (wire with auth API that validates JWT + session state)
      auth_request /_auth;
      auth_request_set $auth_status $upstream_status;

      proxy_pass http://storage_minio/streams/$asset_path;
      proxy_http_version 1.1;

      if ($asset_path ~* "\.ts$") {
        add_header Cache-Control "public,max-age=30";
        proxy_cache hls_cache;
        proxy_cache_valid 200 30s;
      }

      if ($asset_path ~* "\.m3u8$") {
        add_header Cache-Control "no-store";
        proxy_no_cache 1;
        proxy_cache_bypass 1;
      }
    }

    location = /_auth {
      internal;
      proxy_pass http://auth_api/internal/validate-playback;
      proxy_set_header X-Original-URI $request_uri;
      proxy_set_header X-Session-Id $session_id;
      proxy_set_header Authorization $http_authorization;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
    }
  }
}
